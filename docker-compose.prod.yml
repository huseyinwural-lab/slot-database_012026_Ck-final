version: '3.8'

services:
  # LOCAL ONLY: Postgres/Redis containers are behind the "localdb" profile.
  postgres:
    profiles: ["localdb"]
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: casino_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d casino_db"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    profiles: ["localdb"]
    image: redis:7-alpine
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Default backend service expects EXTERNAL DATABASE_URL / REDIS_URL.

  backend-migrate:
    profiles: ["localdb"]
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    restart: "no"
    environment:
      PYTHONUNBUFFERED: "1"
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-casino_db}}
      SYNC_DATABASE_URL: ${SYNC_DATABASE_URL:-postgresql+psycopg2://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-casino_db}}
      REDIS_URL: ${REDIS_URL:-}
      REDIS_REQUIRED: ${REDIS_REQUIRED:-false}
      ENV: ${ENV:-prod}
      CI_STRICT: ${CI_STRICT:-0}
      DEBUG: "False"
      JWT_SECRET: ${JWT_SECRET}
      JWT_ALGORITHM: HS256
      CORS_ORIGINS: ${CORS_ORIGINS}
      DB_POOL_SIZE: ${DB_POOL_SIZE:-5}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW:-10}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-auto}

      # Build metadata
      APP_VERSION: ${APP_VERSION:-unknown}
      GIT_SHA: ${GIT_SHA:-unknown}
      BUILD_TIME: ${BUILD_TIME:-unknown}

      # Security: No defaults/fallbacks for credentials
      BOOTSTRAP_ENABLED: "false"
      BOOTSTRAP_OWNER_EMAIL: ${BOOTSTRAP_OWNER_EMAIL}
      BOOTSTRAP_OWNER_PASSWORD: ${BOOTSTRAP_OWNER_PASSWORD}
    depends_on:
      postgres:
        condition: service_healthy
    command: ["sh", "-lc", "alembic upgrade head"]

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    restart: always
# env_file removed (CI should not hard-fail if backend/.env is absent)
    depends_on:
      backend-migrate:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
    environment:
      PYTHONUNBUFFERED: "1"
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-casino_db}}
      SYNC_DATABASE_URL: ${SYNC_DATABASE_URL:-postgresql+psycopg2://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-casino_db}}
      REDIS_URL: ${REDIS_URL:-}
      REDIS_REQUIRED: ${REDIS_REQUIRED:-false}
      ENV: ${ENV:-prod}
      CI_STRICT: ${CI_STRICT:-0}
      DEBUG: "False"
      JWT_SECRET: ${JWT_SECRET}
      JWT_ALGORITHM: HS256
      CORS_ORIGINS: ${CORS_ORIGINS}
      DB_POOL_SIZE: ${DB_POOL_SIZE:-5}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW:-10}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-auto}

      # Build metadata (set by CI/build)
      APP_VERSION: ${APP_VERSION:-unknown}
      GIT_SHA: ${GIT_SHA:-unknown}
      BUILD_TIME: ${BUILD_TIME:-unknown}

      # Security: No defaults/fallbacks for credentials
      BOOTSTRAP_ENABLED: ${BOOTSTRAP_ENABLED:-false}
      BOOTSTRAP_OWNER_EMAIL: ${BOOTSTRAP_OWNER_EMAIL}
      BOOTSTRAP_OWNER_PASSWORD: ${BOOTSTRAP_OWNER_PASSWORD}
    ports:
      - "8001:8001"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8001/api/ready || exit 1"]
      interval: 5s
      timeout: 2s
      retries: 30
      start_period: 60s

  frontend-admin:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        REACT_APP_BACKEND_URL: ${REACT_APP_BACKEND_URL}
        APP_VERSION: ${APP_VERSION:-unknown}
        GIT_SHA: ${GIT_SHA:-unknown}
        BUILD_TIME: ${BUILD_TIME:-unknown}
    restart: always
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "3000:80"

  frontend-player:
    profiles: ["player"]
    build:
      context: ./frontend-player
      dockerfile: Dockerfile.prod
      args:
        VITE_API_URL: ${VITE_API_URL}
        APP_VERSION: ${APP_VERSION:-unknown}
        GIT_SHA: ${GIT_SHA:-unknown}
        BUILD_TIME: ${BUILD_TIME:-unknown}
    restart: always
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "3001:80"

volumes:
  postgres_data:
