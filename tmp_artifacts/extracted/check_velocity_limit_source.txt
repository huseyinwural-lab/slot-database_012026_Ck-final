=== check_velocity_limit contains utcnow? ===
True
async def check_velocity_limit(
    session,
    *,
    player_id: str,
    action: ActionType,
):
    """Enforce global velocity limit (spam protection).

    Raises HTTPException(429) if too many requests in short window.
    """

    from config import settings

    limit_count = settings.max_tx_velocity_count
    window_minutes = settings.max_tx_velocity_window_minutes

    # DB uses TIMESTAMP WITHOUT TIME ZONE in several environments.
    # Keep comparisons deterministic by using naive UTC timestamps.
    now = _naive_utc(datetime.utcnow())
    window_start = _naive_utc(now - timedelta(minutes=window_minutes))

    stmt = select(func.count(Transaction.id)).where(
        Transaction.player_id == player_id,
        Transaction.created_at >= window_start,
        Transaction.type == ("deposit" if action == "deposit" else "withdrawal"),
    )

    count = (await session.execute(stmt)).scalar_one() or 0

    if count >= limit_count:
        raise HTTPException(
            status_code=429,
            detail={
                "error_code": "VELOCITY_LIMIT_EXCEEDED",
                "message": f"Too many {action} requests. Please wait.",
                "limit": limit_count,
                "window_minutes": window_minutes,
            },
        )

