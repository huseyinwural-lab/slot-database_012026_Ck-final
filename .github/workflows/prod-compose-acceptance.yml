name: Prod Compose Acceptance (Postgres + Migrations)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  prod_compose_acceptance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify Required Secrets
        run: |
          # Zorunlu değişkenlerin kontrolü
          if [ -z "${{ secrets.POSTGRES_PASSWORD }}" ]; then echo "Error: POSTGRES_PASSWORD secret is missing"; exit 1; fi
          if [ -z "${{ secrets.JWT_SECRET }}" ]; then echo "Error: JWT_SECRET secret is missing"; exit 1; fi

      - name: Set up CI Environment
        run: |
          echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> $GITHUB_ENV
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> $GITHUB_ENV
          mkdir -p test-results

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Pytest & Dependencies (Runner-side)
        run: |
          # Testleri container dışından koşturmak için gerekli paketler
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx sqlmodel python-jose[cryptography]

      - name: Build and Start Services
        run: |
          docker-compose --profile localdb build
          docker-compose --profile localdb up -d

      - name: Run Acceptance Tests (Runner to Container)
        env:
          TEST_TARGET_URL: "http://localhost:8001" # Backend container adresi
        run: |
          # Runner üzerinden canlı container'a HTTP isteği atarak test et
          pytest backend/tests/acceptance --junitxml=test-results/results.xml

      - name: Archive Diagnostic Logs
        if: always()
        run: |
          docker-compose logs backend > test-results/backend-logs.txt
          docker-compose logs postgres > test-results/postgres-logs.txt
          echo "Diagnostic logs collected."

      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-test-report
          path: test-results/
