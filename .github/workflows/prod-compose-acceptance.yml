name: Prod Compose Acceptance (Postgres + Migrations)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  prod_compose_acceptance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up CI Environment
        run: |
          echo "POSTGRES_PASSWORD=postgres" >> $GITHUB_ENV
          echo "JWT_SECRET=test_secret_key_012026" >> $GITHUB_ENV
          mkdir -p test-results # ✅ Karar 1: Standart Dizin

      - name: Build Services
        run: docker-compose --profile localdb build

      - name: Start Services & Wait for Health
        run: docker-compose --profile localdb up -d

      - name: Run Acceptance Tests (Pytest)
        run: |
          # ✅ Karar 1 & 2: Sağlıklı DB üzerinde testleri koştur
          docker-compose exec -T backend pytest backend/tests/acceptance --junitxml=test-results/results.xml

      - name: Archive Diagnostic Logs
        if: always() # ✅ Karar 3: Test kalsa da logları al
        run: |
          docker-compose logs backend > test-results/backend-logs.txt
          docker-compose logs postgres > test-results/postgres-logs.txt
          echo "Diagnostic logs collected in test-results/"

      - name: Upload Test Artifacts
        if: always() # ✅ Karar 3: Kanıtları yükle
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-test-report
          path: test-results/
