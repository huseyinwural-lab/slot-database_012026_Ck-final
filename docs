# Game Config – Paytable Module

## Models

### PaytableRecord
- `id: string` – UUID
- `game_id: string`
- `config_version_id: string`
- `data: object` – raw paytable JSON
- `source: "provider" | "override"`
- `schema_version: string` – e.g. `"1.0.0"`
- `created_at: datetime`
- `created_by: string`

### PaytableHistoryItem
- `config_version_id: string`
- `source: string`
- `created_at: datetime`
- `created_by: string`
- `summary?: string`

### PaytableResponse
- `current?: PaytableRecord`
- `history: PaytableHistoryItem[]`

## Endpoints

### GET /api/v1/games/{id}/config/paytable
Returns active paytable and short history.

### POST /api/v1/games/{id}/config/paytable/override
Creates a new override paytable and new GameConfigVersion.

Validation rules:
- `data.symbols` must be a non-empty array.
- Each symbol must have `code` string.
- `pays` must be an object; all values must be numeric and `>= 0`.
- If `lines` is present it must be integer `>= 1`.

On success:
- Creates new `GameConfigVersion` with status `draft`.
- Inserts PaytableRecord with `source = "override"` and `schema_version = "1.0.0"`.
- Writes a `game_logs` entry with `action = "paytable_override_saved"`.
- Creates `ApprovalRequest` with `category = GAME` and `action_type = "paytable_change"`.

### POST /api/v1/games/{id}/config/paytable/refresh-from-provider
Stub endpoint that simulates pull from provider.

- Creates new `GameConfigVersion`.
- Inserts PaytableRecord with `source = "provider"` and mock data.
- Writes `game_logs` entry with `action = "paytable_refreshed_from_provider"`.

## Error Format

All 4xx responses from paytable validation use a fixed JSON format:

```json
{
  "error_code": "PAYTABLE_VALIDATION_FAILED",
  "message": "symbols alanı zorunludur.",
  "details": {
    "field": "data.symbols",
    "reason": "missing"
  }
}
```

Lock-related errors use `error_code = "PAYTABLE_LOCKED"`.

## Structured Logging

Every paytable endpoint uses structured logging fields:
- `game_id`
- `config_version_id`
- `admin_id`
- `request_id` (trace / correlation id, if available)
- `action_type` (e.g. `paytable_get`, `paytable_override`, `paytable_refresh`)

These are emitted via the `game_logs` collection and application logging for easier debugging and traceability.
